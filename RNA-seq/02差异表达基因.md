# 差异表达基因

在得到基因的表达量之后，通过比较不同组织间基因表达水平的差异，或者不同时期间表达水平的差异来筛选差异表达基因



### reads计数

使用python包HTseq对统计每个基因比对到的read数

#### 软件安装

非root用户需要使用`--user`参数

```bash
pip3 install HTSeq --user
```

#### 统计基因比对上的read数 

由于我的bam文件需要使用stringtie计算表达量，所以已经经过按照染色体位置排序和质量过滤了

```bash
 htseq-count  -f bam -r pos -t exon -i gene_id  -m union -q  1_1_5_rmdup.bam genome.gtf >count.txt 
```

```bash
# 命令参数
-f | --format default: sam 设置输入文件的格式，该参数的值可以是sam或bam。
-r | --order default: name 设置sam或bam文件的排序方式，该参数的值可以是name或pos。前者表示按read名进行排序，后者表示按比对的参考基因组位置进行排序。若测序数据是双末端测序，当输入sam/bam文件是按pos方式排序的时候，两端reads的比对结果在sam/bam文件中一般不是紧邻的两行，程序会将reads对的第一个比对结果放入内存，直到读取到另一端read的比对结果。因此，选择pos可能会导致程序使用较多的内存，它也适合于未排序的sam/bam文件。而pos排序则表示程序认为双末端测序的reads比对结果在紧邻的两行上，也适合于单端测序的比对结果。很多其它表达量分析软件要求输入的sam/bam文件是按pos排序的，但HTSeq推荐使用name排序，且一般比对软件的默认输出结果也是按name进行排序的。
-s | --stranded default: yes 设置是否是链特异性测序。该参数的值可以是yes,no或reverse。no表示非链特异性测序；若是单端测序，yes表示read比对到了基因的正义链上；若是双末端测序，yes表示read1比对到了基因正义链上，read2比对到基因负义链上；reverse表示双末端测序情况下与yes值相反的结果。根据说明文件的理解，一般情况下双末端链特异性测序，该参数的值应该选择reverse（本人暂时没有测试该参数）。
-a | --a default: 10 忽略比对质量低于此值的比对结果。在0.5.4版本以前该参数默认值是0。
-t | --type default: exon 程序会对该指定的feature（gtf/gff文件第三列）进行表达量计算，而gtf/gff文件中其它的feature都会被忽略。
-i | --idattr default: gene_id 设置feature ID是由gtf/gff文件第9列哪个标签决定的；若gtf/gff文件多行具有相同的feature ID，则它们来自同一个feature，程序会计算这些features的表达量之和赋给相应的feature ID。
-m | --mode default: union 设置表达量计算模式。该参数的值可以有union, intersection-strict and intersection-nonempty。这三种模式的选择请见上面对这3种模式的示意图。从图中可知，对于原核生物，推荐使用intersection-strict模式；对于真核生物，推荐使用union模式。
-o | --samout 输出一个sam文件，该sam文件的比对结果中多了一个XF标签，表示该read比对到了某个feature上。
-q | --quiet 不输出程序运行的状态信息和警告信息。
-h | --help 输出帮助信息。
```

计数模式图

![](https://upload-images.jianshu.io/upload_images/6049898-721e9cbe006abbe3.png)

#### 输出结果

```bash
Ghir_A01G000010	11
Ghir_A01G000020	10
Ghir_A01G000030	20
Ghir_A01G000040	139
Ghir_A01G000050	9
Ghir_A01G000060	52
Ghir_A01G000070	68
__no_feature	8716242
__ambiguous	157518
__too_low_aQual	0
__not_aligned	0
__alignment_not_unique	0
```

#### 批量提交任务

```bash
for i in `ls `
do
bsub -J htseqCount -q "smp" -n 1 -R span[hosts=1] -e htseqCount.err -o htseqCount.out "bash htseqcount.sh ${i}"
sleep 1
done
```

### 1.样品无重复

​	使用DESeq包，对于技术重复作者推荐将两个技术重复的read进行加和后作为样本的read数

>  For technical replicates (e. g. when the same library preparation was distributed over multiple lanes of the sequencer), please sum up their counts to get a single column, corresponding to a unique biological replicate.  

#### 读取原始read数据

其中行名为基因名，列名为样本名

```bash
	untreated3 untreated4 treated2 treated3
FBgn0000003 0 0 0 1
FBgn0000008 76 70 88 70
FBgn0000014 0 0 0 0
FBgn0000015 1 2 0 0
FBgn0000017 3564 3150 3072 3334
FBgn0000018 245 310 299 308
```

补充样品分组信息

第一列与第二列属于`untreated`处理的两个重复

```R
condition = factor( c( "untreated", "untreated", "treated", "treated" ) )
```

进行差异分析

```R
> library( "DESeq" )
> cds = newCountDataSet( countTable, condition )
```

#### 对不同处理进行标准化

通过` estimateSizeFactors( cds ) `函数来计算不同处理间测序深度是否存在较大的差异

```R
estimateSizeFactors( cds )
```

#### 输出结果

+ id feature identifier baseMean mean normalised counts, averaged over all samples from both conditions +
+ baseMeanA mean normalised counts from condition A 
+ baseMeanB mean normalised counts from condition B foldChange 
+ fold change from condition A to B 
+ log2FoldChange the logarithm (to basis 2) of the fold change 
+ pval p value for the statistical significance of this change 
+ padj p value adjusted for multiple testing with the Benjamini-Hochberg procedure (see the R function p.adjust), which controls false discovery rate (FDR)  

```bash
id baseMean baseMeanA baseMeanB foldChange log2FoldChange pval padj
1 FBgn0000003 0.224 0.00 0.449 Inf Inf 1.000 1.000
2 FBgn0000008 76.296 78.16 74.436 0.952 -0.0704 0.835 1.000
3 FBgn0000014 0.000 0.00 0.000 NaN NaN NA NA
4 FBgn0000015 0.781 1.56 0.000 0.000 -Inf 0.416 1.000
5 FBgn0000017 3298.682 3599.47 2997.890 0.833 -0.2638 0.241 0.881
6 FBgn0000018 289.031 293.68 284.385 0.968 -0.0464 0.757 1.000
```

### 2.样品有重复

​	推荐使用DESeq2包



### 参考

1. HTSeq仓库  https://github.com/simon-anders/htseq 
2. HTSeq使用文档  https://htseq.readthedocs.io/en/release_0.11.1/ 
3. HTSeq使用文档  https://www.cnblogs.com/triple-y/p/9338890.html 
4. DESeq使用文档  https://bioconductor.org/packages/release/bioc/vignettes/DESeq/inst/doc/DESeq.pdf 

