可变剪切的鉴定

为了方便在不同的基因组之间进行比较，AS的鉴定还是选择那些比较PacBio转录本之间的AS；从11_AS/end_splice.txt`文件中提取两个转录本都是PB注释的AS。将冗余的内含子保留信息合并一下

> 公司在鉴定AS的时候，把PB和参考基因组的转录本进行了合并；用参考基因组中原有的注释代替了PacBio的注释；而A2中只有一个转录本的注释。所以当我去取两个都是PB的转录本的时候，A2的就会比较多。
>
> 重新鉴定AS，使用gmap将PacBio比对到参考基因组输出格式设置为cDNA格式的gff文件
>
> 在使用AS的脚本去鉴定AS

+ test.gff 文件为Gmap的输出结果
+ PacBio.gff为PacBio转录本的注释信息
+ as  统计剪切位点处的编码
+ ats  输出AS鉴定的统计信息
+ os 输出剪切处的fasta序列
+ op 输出SVG图片信息

```bash
##先使用GMap进行比对
##再比对PacBio转录本之间的信息，使用脚本
/usr/bin/python ~/software/pipeline-for-isoseq/other/alternative_splice.py -i ./test.gff -g ./PacBio.gtf  -f ~/work/Alternative/data/Ghirsutum_genome_HAU_v1.0/Ghirsutum_genome_HAU_v1.0.fasta -as -ats T -os  -t exon   -op -o /public/home/zpliu/work/Alternative/result/Gh_result/CO31_32_result/11_AS/alter_splice
##使用脚本对根据剪切编码进行分类
python ~/scripte/Alternative/classSplice.py
##根据去除冗余后的isoform提取其中的AS
python adjustAS.py -isoformId /public/home/zpliu/work/Alternative/result/homologo/FEST5/isoform/cdHit/A2_merge_isoform  -AS alter_splice2/111  -o test
```

```bash
###去除冗余
python ~/work/Alternative/result/homologo/FEST4/conserveAS/allAS/arrangeAS.py  -h
##统计数目
```

#### 使用AS脚本鉴定AS

只鉴定PacBio转录本之间的IR，首先需要将`../07_annotation/TM-1_merge_C.gtf`文件中只提取PacBio的注释信息

```bash
##提取有基因注释的PacBio转录本信息，里面包含了lncRNA
grep "PB" ../07_annotation/TM-1_merge_C.gtf >PacBio.gtf
## 运行鉴定可变剪切的脚本
```

统计各个棉种中的数量信息，在没去冗余之前

| 基因组 | IR    | ES   | AltA | AltD | AltP | Other |
| ------ | ----- | ---- | ---- | ---- | ---- | ----- |
| TM1    | 36172 | 2503 | 8033 | 6422 | 5876 | 4041  |
| D5     | 22540 | 1323 | 4669 | 3617 | 3648 | 2465  |
| A2     | 32179 | 2386 | 7186 | 5646 | 5553 | 3995  |

去完冗余转录本后，AS的统计
| 基因组 | IR    | ES   | AltA | AltD | AltP | Other |
| ------ | ----- | ---- | ---- | ---- | ---- | ----- |
| TM1    | 33225 | 2208 | 6144 | 4848 | 3796 | 2549  |
| D5     | 20680 | 1171 | 3497 | 2628 | 2343 | 1513  |
| A2     | 29488 | 2120 | 5411 | 4256 | 3570 | 2448  |



### 使用`lr2rmats`更新转录本的注释

#### 安装

```bash
git clone https://github.com/Xinglab/lr2rmats.git --recursive
cd lr2rmats
make dependencies
make lr2rmats
export PATH=$PATH:$PWD/bin # To permanently modify your PATH, you need to add it to your ~/.profile or ~/.bashrc file. 
```

安装对应的依赖` snakemake`

```bash
 conda create -n  snakemake  -c conda-forge -c bioconda snakemake
```

**看了一下`Snakemake`这个配置文件，里面就不会自己调用minimap2 去建立索引，垃圾的一批；**

参考文件内的命令，手动建立索引文件

```bash
# Snakemake文件内部
"{params.minimap} -x splice {input} -d {output} -t {threads} 2> {log}"
minimap2  -d genome.fa.mmi Ghirsutum_genome_HAU_v1.0.fasta
##使用STAR建立基因组索引
"{params.star} --runMode genomeGenerate --runThreadN {threads} --genomeFastaFiles {input} --genomeDir {output} --outFileNamePrefix {log} >> {log}"
~/github/lr2rmats/bin/STAR  --runMode genomeGenerate --runThreadN 10 --genomeFastaFiles genome/G
hirsutum_genome_HAU_v1.0.fasta  --genomeDir  ./genome.STAR/
##修改一下文件的绝对路径，然后run起来
snakemake -p --snakefile  ./Snakefile  --configfile ./config.yaml
```

### 输出文件

在` output`文件夹中生成了几种gtf文件

+ `know.gtf`PacBio测的转录本在基因组注释文件中已经存在
+ `novel.gtf`PacBio测到的转录本与注释的转录本不一样，但是存在至少一个相同的剪切位点
+ `unrecog.gtf` PacBio中的剪切位点与参考基因组没有重叠
+ `updated.gtf`改进后的参考转录本信息；在原有基因组注释的基础上，加上`novel`转录本信息，并且这些新的转录本信息是由long-read和short read支持的。

### 使用`rmats-turbo`鉴定AS 

#### 安装软件

```bash
##使用conda环境
conda create  -n rmats-turbo python=3.6
conda activate rmats-turbo
##安装这些依赖项
pip install Cython==0.29.14 --user
pip install numpy==1.16.5 --user
conda install BLAS LAPACK -y
conda install GSL=2.5
#conda install GCC=5.4.0
conda install CMake=3.15.4
conda install gfortran
```

#### 一行命令搞定

> 错误`bash: gsl-config: command not found`
>
> 主要是由于`./build_rmats `这个脚本运行过程中会`source ~/.bashrc`进入base环境就找不到脚本
>
> 解决办法把`conda_envs/rmats/bin`添加到环境变量里

```bash
##先加载GSL
module load GSL/2.4
##使用conda安装依赖
./build_rmats   --conda
```

### 参考

1. [STAR](https://github.com/alexdobin/STAR)
2. [lr2rmats](https://github.com/Xinglab/lr2rmats)
3. [rmats-turbo](https://github.com/Xinglab/rmats-turbo/tree/v4.1.0)