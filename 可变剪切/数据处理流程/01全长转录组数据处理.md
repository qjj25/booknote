# 01全长转录组数据处理

### 测序数据如下图

<img src="https://43423.oss-cn-beijing.aliyuncs.com/img/20191009131705.png"/>

+ 每个棉种含有两个重复的数据，之所以有3个文件，是因为有一个重复的数据量没有测够；之后进行了补测

***2019-10-10***

~~合并两次测序的bam文件~~

```bash
## 分别对两个bam文件进行排序，按照序列编号顺序排序
samtools sort -n -@ 2 ./A2/dT_BC5_subreads.bam -O BAM -o ./A2/dT_BC5_subreads_sorted.bam
## 将两个排序好的文件进行合并
samtools merge -n -@ 2 -O BAM ./A2/A2_R2.subreads.bam ./A2/dT_BC5_subreads_sorted.bam ./A2/m54139_180604_080709.subreads_sorted.bam
```

后来发现还得使用ccs方法将两个bam文件指定为一个数据集

***2019-10-11***

因为在进行数据打磨时报错了

`Missing .pbi file`

```bash
dataset create A2_R2.subreadset.xml --type SubreadSet --generateIndices ./../dT_BC5_subreads.bam ./../m54139_180604_080709.subreads.bam
# 之后使用A2_R2.subreadset.xml文件代替bam文件进行ccs即可
```



***2019-10-13***

使用iso-seq中dataset程序处理，重复二的数据

```bash
dataset create R2/TM1_R2.subreadset.xml --type SubreadSet --generateIndices R1801371_QJ_BC1_subreads.bam m54139_180607_052119.subreads.bam &
dataset create R2/D5_R2.subreadset.xml --type SubreadSet --generateIndices m54136_180730_021327.subreads.bam m54139_180609_044201.subreads.bam &
```

使用ccs处理

```bash
ccs --noPolish --minPasses 1 --minLength 300 --minSnr 4 --maxLength 10000 --maxDropFraction 0.8 --minPredictedAccuracy 0.8 --numThreads 20 --logFile ./TM1_R2_ccs.log --reportFile ./TM1_R2port_ccs.txt ./TM1_R2.subreadset.xml  ./TM1_R2_ccsout.bam
```

****

之前数据的分析，师姐已经完成了；接下来主要是针对数据进行个性化的分析了；其实我还挺想自己把流程走一遍的，可惜公司不会把分析流程的protocol发给我们

***2019-10-14***

将之前的结果解压,到当前文件夹

`unrar x result.rar`

~~参考我之前写的软件使用说明~~

~~tps://zpliu.gitbook.io/booknote/ke-bian-jian-qie/ruan-jian-shi-yong/01-san-dai-ce-xu-isoseq#2-shi-yong-ccs-dui-yuan-shi-shu-ju-jin-hang-guo-lv~~

#### 统计测序序列情况

1.二倍体亚洲棉

数据来源：第三步分析流程里文件`Classify_stat.xls`

***CO_31***

|                序列类型                |  数目  |  比例  |
| :------------------------------------: | :----: | :----: |
|    consensus reads质控后经过ccs处理    | 320874 |  100%  |
|         non-full-length reads          | 34265  | 10.68% |
| full-length reads（包括chimeric reads) | 286277 | 89.22% |
|   filtered short reads长度小于300bp    |  332   |  0.1%  |
|             chimeric reads             |  9710  | 3.03%  |

***CO_32***

|                序列类型                |  数目  |  比例  |
| :------------------------------------: | :----: | :----: |
|    consensus reads质控后经过ccs处理    | 292447 |  100%  |
|         non-full-length reads          | 34265  | 10.68% |
| full-length reads（包括chimeric reads) | 228041 | 77.98% |
|   filtered short reads长度小于300bp    |  366   | 0.13%  |
|             chimeric reads             | 11003  | 3.77%  |


2. 四倍体陆地棉

   ***Col31&C0l32***
|                序列类型                |  数目  |  比例  |
| :------------------------------------: | :----: | :----: |
|    consensus reads质控后经过ccs处理    | 685383 |  100%  |
|         non-full-length reads          | 103674 | 15.13% |
| full-length reads（包括chimeric reads) | 581611 | 84.86% |
|   filtered short reads长度小于300bp    |   98   | 0.01%  |
|             chimeric reads             | 18914  | 2.76%  |



3. 二倍体雷蒙德氏棉

   ***Col31&C0l32***
   |                序列类型                |  数目  |  比例  |
   | :------------------------------------: | :----: | :----: |
   |    consensus reads质控后经过ccs处理    | 487063 |  100%  |
   |         non-full-length reads          | 87450  | 17.95% |
   | full-length reads（包括chimeric reads) | 399112 | 81.94% |
   |   filtered short reads长度小于300bp    |  501   |  0.1%  |
   |             chimeric reads             | 26652  | 5.47%  |

   

   


​	

### 比较测序数据与参考基因组数据中isform的长度与对应exon的数目

+ 在测序数据中`06_Alignment/all.collapsed.gff`文件中有每条isform的信息

  1.统计每条isform的长度信息，**只包含外显子的长度**

  2.统计每条isform的外显子数目

  ```bash
  sed 's/gene_id [^t]*transcript_id//g' all.collapsed.gff |awk '$3~/^e/{isformLen[$9]+=$5-$4+1;exonCount[$9]+=1}END{for(i in isformLen){printf i"\t"isformLen[i]"\t"exonCount[i]"\n"}}'
  ```

  ```bash
  ##得到每个isform的长度和外显子数目
  "PB.1024.1";    4680    5
  "PB.10242.1";   3658    7
  "PB.1024.2";    4463    5
  "PB.10243.1";   2680    3
  
  ```

  

+ 参考基因组gff文件中有每个mRNA的注释信息

  多了一个sed的处理主要是isform的第九列多了·一些信息`ID=evm.model.Ga01G0001.exon2`，把exon那部分去除后获得isform编号

  ```bash
  awk -F ";" '{print $1}' Ghirsutum_gene_model.gff3|sed 's/\.exon.*//g' |awk '$3~/^e/{isformLen[$9]+=$5-$4+1;exonCount[$9]+=1}END{for(i in isformLen){printf i"\t"isformLen[i]"\t"exonCount[i]"\n"}}'
  ```

+ 准备绘图的数据

  ```bash
  # 将isform名字信息修改成分组信息
   sed -i 's/\"PB[^\t]*/TM1_PBisform/g' my_isform_length_exonCount.txt
  # 修改基因组的isform信息
  sed -i 's/\ID=[^\t]*/TM1_genome/g' my_genome_isform_length_exonCount.txt
  # 将多个棉种的数据合并成一个文件，比较外显子数目上的差异
  awk '{exonClass[$1"*"$3]+=1}END{for(i in exonClass){split(i,tmp,"*");printf tmp[1]"\t"tmp[2]"\t"exonClass[i]"\n"}}' all_genome_isform_comprasion.txt      >all_genome_isform_exonCount.txt
  ```
  
  得到每个基因组中isform的外显子数目分布情况
  
  ```bash
  #基因组	外显子数目	对应的isform数目
  TM1_genome	64	3
  D5_PBisform	43	7
  D5_genome	16	674
  TM1_genome	65	1
  D5_PBisform	44	13
  D5_genome	30	51
  ```

***2019-10-16***

+ 绘制isform长度比较信息，和外显子数目的比较信息

  ```R
  #绘制isform长度信息
  ggplot(data = tmp,aes(x=tmp$V2,y=tmp$V3,fill=tmp$V2))+geom_boxplot()+ facet_wrap(~tmp$V1,scales = "free")
  ```

  

  ```R
  # 绘制isform中外显子的数目信息
  ggplot(data = tmp,aes(x=tmp$V3,y=tmp$V4,fill=tmp$V2))+geom_bar(stat = "identity", position = 'dodge')+scale_x_continuous(breaks = seq(1,20,1))+facet_wrap(~tmp$V1)
  ```


***2019-10-17***

第7个文件夹annotation中包含了，与参考基因组注释文件进行合并后的注释信息

利用地6步分析中得到的非冗余的isform序列，与基因组进行比较

| 棉种 | 非冗余的isform | 比对到注释基因的isform | 没有比对到基因区域 | 对应基因数 | 对应的转录本数               | 注释基因数目 |
| ---- | -------------- | ---------------------- | ------------------ | ---------- | ---------------------------- | ------------ |
| TM1  | 89,411         | 83,281                 | 6,130              | 32,003     | 39,098                       |              |
| A2   | 7,2393         | 69,179                 | 3,214              | 20,907     | 参考基因组没有预测不同转录本 |              |
| D5   | 55,381         | 53,058                 | 2,323              | 18,904     | 24,368                       |              |



第8个和第9个、10个文件的数据暂时用不到

**分析第11个关于可变剪切的文件**













